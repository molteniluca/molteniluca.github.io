<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ToH CTF 2025 - Sqlite weirdness - Luca Molteni&#39;s Blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="For the ToH CTF 2025, I originally wanted to create an easy web challenge. During that process, I stumbled upon an interesting behavior in SQLite, which inspired me to turn it into a much harder challenge instead." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://molteniluca.gihtub.io/posts/sqlite_weirdness/">
  <meta property="og:site_name" content="Luca Molteni&#39;s Blog">
  <meta property="og:title" content="ToH CTF 2025 - Sqlite weirdness">
  <meta property="og:description" content="For the ToH CTF 2025, I originally wanted to create an easy web challenge. During that process, I stumbled upon an interesting behavior in SQLite, which inspired me to turn it into a much harder challenge instead.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-07-27T00:00:00+00:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ToH CTF 2025 - Sqlite weirdness">
  <meta name="twitter:description" content="For the ToH CTF 2025, I originally wanted to create an easy web challenge. During that process, I stumbled upon an interesting behavior in SQLite, which inspired me to turn it into a much harder challenge instead.">

        <link href="https://molteniluca.gihtub.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://molteniluca.gihtub.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://molteniluca.gihtub.io/">Luca Molteni&#39;s Blog</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">ToH CTF 2025 - Sqlite weirdness</h1>
          <div class="meta">Posted on Jul 27, 2025</div>
        </div>
        
        <section class="body">
          <p>For the ToH CTF 2025, I originally wanted to create an easy web challenge. During that process, I stumbled upon an interesting behavior in SQLite, which inspired me to turn it into a much harder challenge instead.</p>
<h1 id="zerodrive">ZeroDrive</h1>
<p>The challenge presents itself as a service that allows uploading 0-byte files and subsequently downloading them.
The flag is located in the root of the filesystem.</p>
<p>The application only has four endpoints:</p>
<ul>
<li><code>/</code>: lists all uploaded files</li>
<li><code>/upload</code>: allows uploading 0B files, but only within the <code>uploads</code> folder</li>
<li><code>/uploads/uuid</code>: allows downloading the uploaded file</li>
<li><code>/rename/uuid</code>: allows renaming the file</li>
</ul>
<h2 id="challenge-source">Challenge source</h2>
<p>You can download the whole challenge deliverable (and exploits) from <a href="deliver.zip">here</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, render_template, request, redirect, url_for, send_file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;uploads&#39;</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DATABASE&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;database.sqlite&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_db_connection</span>():
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DATABASE&#39;</span>])
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>row_factory <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>Row
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> conn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> get_db_connection() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        files <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;SELECT * FROM files&#39;</span>)<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>, files<span style="color:#f92672">=</span>files)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/upload&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_file</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>files:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(request<span style="color:#f92672">.</span>url)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#39;file&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(file<span style="color:#f92672">.</span>read()) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;File size exceeds 0 bytes&#39;</span>, <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        uuid_file <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4())
</span></span><span style="display:flex;"><span>        save_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>normpath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], file<span style="color:#f92672">.</span>filename))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;../&#34;</span> <span style="color:#f92672">in</span> save_path <span style="color:#f92672">or</span> save_path<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;/&#34;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Invalid filename&#39;</span>, <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        file<span style="color:#f92672">.</span>save(save_path)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> get_db_connection() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;INSERT INTO files (filename, uuid) VALUES (?, ?)&#39;</span>, (file<span style="color:#f92672">.</span>filename, uuid_file))
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;uploads/&#39;</span><span style="color:#f92672">+</span>uuid_file)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;upload.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/uploads/&lt;uuid_file&gt;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">view_file</span>(uuid_file):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> get_db_connection() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        file <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;SELECT * FROM files WHERE uuid = ?&#39;</span>, (uuid_file,))<span style="color:#f92672">.</span>fetchone()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> file:
</span></span><span style="display:flex;"><span>        path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>normpath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], file[<span style="color:#e6db74">&#39;filename&#39;</span>]))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> send_file(path)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;File not found&#39;</span>, <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/rename/&lt;uuid_file&gt;&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_file</span>(uuid_file):
</span></span><span style="display:flex;"><span>    new_filename <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>json<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;new_filename&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> get_db_connection() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;BEGIN TRANSACTION&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            file <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;SELECT * FROM files WHERE uuid = ?&#39;</span>, (uuid_file,))<span style="color:#f92672">.</span>fetchone()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;UPDATE files SET filename = ? WHERE uuid = ?&#39;</span>, (new_filename, uuid_file))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            old_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>normpath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], file[<span style="color:#e6db74">&#39;filename&#39;</span>]))
</span></span><span style="display:flex;"><span>            new_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>normpath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], new_filename))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;../&#34;</span> <span style="color:#f92672">in</span> new_path <span style="color:#f92672">or</span> new_path<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;/&#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Invalid filename&#39;</span>, <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            shutil<span style="color:#f92672">.</span>move(old_path, new_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Operation failed </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;index&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>)
</span></span></code></pre></div><p>A trivial initial vulnerability lies in the fact that a single <code>../</code> path traversal is allowed, which makes it possible to upload files to the main folder of the challenge. This potentially allows overwriting (with a 0B file) the database file itself (which would just break the challenge).</p>
<p>The only other writable file in that folder is the journaling file (created and removed whenever an explicit transaction is performed).</p>
<h1 id="sqlite-wtf">SQLite WTF</h1>
<p>When you start a transaction in SQLite, you expect the database to be able to fully roll it back on request. At some point, I wondered: how much RAM can SQLite use to handle such operations? The answer is just 10 MB.</p>
<p>If the data involved in the transaction exceeds this threshold (for example, when replacing a string larger than 10 MB), SQLite uses a temporary on-disk file (the journal file) to perform a rollback in case of error.</p>
<p>This is where a curious behavior comes into play: if the journal file is emptied during a transaction, you would expect SQLite to no longer be able to roll back. This is actually true unless the modification involves data fields of the same size as those already present in the database.</p>
<p>In these particular cases, for example, when you execute a query that replaces a string with another of equal length, if a transaction is reverted in this case and if journal file is cleaned during the operation, the transaction can only be partially rolled back. This behavior can lead to inconsistent database states, without obvious failure signals.</p>
<p>The cause for this behavior resides in the fact that sqlite trusts the journaling file. If the file is emptied sqlite does not find any chunks of memory to revert stored inside it and it fails to revert those chunks of memory.</p>
<h1 id="challenge">Challenge</h1>
<p>In my application, when passing a path of about 50 MB to the database, I observed that the journal file remains on disk for about 0.4 seconds (this is because Python&rsquo;s <code>normpath</code> is slow with 50MB). This short interval represents the only useful window to potentially manipulate it.</p>
<p>If I go ahead and actually empty this file during the transaction and then the transaction is reverted, the result is that the string in the DB at the end will be partially the one from the beginning of the transaction and partially the one from the supposedly successful transaction.
The resulting string in the DB is something like <code>ABBBBBA</code>, where A is part of the original string and B is part of the new string as if the transaction had succeeded.</p>
<p>To summarize, the steps are:</p>
<ul>
<li>Upload a file</li>
<li>Rename that file using a long 50MB path <code>samepath</code> that, once normalized, points to <code>flag.txt</code></li>
<li>Rename the file again using another 50MB path that is identical to the previous one but with some <code>../../../</code> in the middle, i.e., a string like: <code>samepath[0:25MB]+'../../../'+samepath[25MB+9B:]</code></li>
<li>Exploit the race condition by uploading a 0B file at the path <code>../database.db-journal</code> (the path of the journal file) concurrently with the step above</li>
<li>Open the file that now points to <code>../../../flag.txt</code></li>
<li>Win</li>
</ul>
<h1 id="remote">Remote</h1>
<p>The biggest challenge in exploiting this remotely lies in correctly synchronizing the two requests for it to work.
To send a large request with more precise timing, a <strong>single packet attack</strong> is used so that the race condition can be timed only on the final packet, reducing the variable to network jitter alone.</p>

        </section>
        <div class="post-tags">
          
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/molteniluca/" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://twitter.com/Luca__molteni/" rel="me" title="Twitter"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#twitter" />
</svg></a><a class="border"></a><a class="soc" href="https://www.linkedin.com/in/lmolteni/" rel="me" title="LinkedIn"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#linkedin" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  Â© Luca Molteni |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
